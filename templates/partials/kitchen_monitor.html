<!-- Kitchen Monitor Section -->
<div class="page-section" id="kitchen-monitor">
    <style>
        #kitchen-monitor .card {
            position: relative;
            z-index: 1;
            pointer-events: all;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #kitchen-monitor .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        #kitchen-cards-container {
            position: relative;
            z-index: 1;
        }
        
        #refresh-timer {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            z-index: 1000;
            min-width: 150px;
            text-align: center;
        }
        
        #refresh-timer .timer-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        #refresh-timer .timer-value {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        #refresh-timer .timer-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        #refresh-timer .timer-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            transition: width 1s linear;
        }
    </style>
    
    <!-- Auto-refresh Timer -->
    <div id="refresh-timer">
        <div class="timer-label">Next Refresh</div>
        <div class="timer-value" id="countdown-value">5</div>
        <div class="timer-progress">
            <div class="timer-progress-bar" id="progress-bar"></div>
        </div>
    </div>
    
    <div class="section-header">
        <h2>üç≥ Kitchen Monitor</h2>
        <p>Real-time kitchen activity and food item preparation status</p>
    </div>
    
    <div class="action-bar">
        <button class="btn btn-primary" onclick="refreshKitchenMonitor()">
            üîÑ Refresh Status
        </button>
    </div>
    
    <div id="kitchen-cards-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
        <!-- Kitchen cards will be populated here -->
        <div style="text-align: center; color: #ccc; padding: 40px; grid-column: 1 / -1;">Loading kitchens...</div>
    </div>
</div>

<!-- Reassign Modal -->
<div id="reassignModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>üîÑ Move Item to Another Kitchen</h3>
            <button class="close-btn" onclick="closeReassignModal()">&times;</button>
        </div>
        <div style="padding: 20px;">
            <p style="margin-bottom: 15px; color: #666;">
                Moving: <strong id="reassignFoodName"></strong>
            </p>
            <div class="form-group">
                <label>Select New Kitchen *</label>
                <select id="reassignKitchenSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select Kitchen --</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReassignModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmReassign()">‚úì Move Item</button>
        </div>
    </div>
</div>

<script>
// Load kitchen monitor data
function loadKitchenMonitor() {
    console.log('üç≥ Loading kitchen monitor...');
    
    fetch('/api/kitchens')
        .then(res => res.json())
        .then(data => {
            const kitchens = data.kitchens || [];
            console.log('  Kitchens:', kitchens);
            
            // Fetch assignments for each kitchen
            Promise.all(
                kitchens.map(kitchen => 
                    fetch(`/api/kitchens/${kitchen.id}/current-assignments`)
                        .then(r => r.json())
                        .then(assignmentData => {
                            console.log(`Assignments for ${kitchen.name}:`, assignmentData);
                            return {
                                ...kitchen,
                                assignments: assignmentData.assignments || []
                            };
                        })
                        .catch(err => {
                            console.error(`Error fetching assignments for kitchen ${kitchen.id}:`, err);
                            return {
                                ...kitchen,
                                assignments: []
                            };
                        })
                )
            ).then(kitchensWithAssignments => {
                console.log('  Kitchens with assignments:', kitchensWithAssignments);
                displayKitchenCards(kitchensWithAssignments);
            });
        })
        .catch(error => {
            console.error('Error loading kitchen monitor:', error);
            document.getElementById('kitchen-cards-container').innerHTML = 
                '<div style="color: #f00; text-align: center; padding: 20px;">Error loading kitchens</div>';
        });
}

// Display kitchen cards
function displayKitchenCards(kitchens) {
    const container = document.getElementById('kitchen-cards-container');
    container.innerHTML = '';
    
    console.log('displayKitchenCards called with:', kitchens);
    
    if (kitchens.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #ccc; padding: 40px; grid-column: 1 / -1;">No kitchens available</div>';
        return;
    }
    
    kitchens.forEach(kitchen => {
        console.log(`Processing kitchen: ${kitchen.name}`);
        console.log(`  Assignments:`, kitchen.assignments);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.cssText = 'padding: 20px; border-left: 4px solid #667eea; position: relative; z-index: 1;';
        
        const assignments = kitchen.assignments || [];
        console.log(`  Assignments count: ${assignments.length}`);
        
        // Calculate based on started/completed flags instead of status
        const notStartedCount = assignments.filter(a => !a.started || a.started === 0).length;
        const inProgressCount = assignments.filter(a => a.started === 1 && a.completed === 0).length;
        const activeCount = notStartedCount + inProgressCount;
        
        console.log(`  Stats - Not Started: ${notStartedCount}, In Progress: ${inProgressCount}, Active: ${activeCount}`);
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #333;">
                    ${kitchen.icon || 'üç≥'} ${kitchen.name}
                </h3>
                <span style="background: ${activeCount > 0 ? '#ffa502' : '#2ecc71'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    ${activeCount} Active
                </span>
            </div>
            
            <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                üìç ${kitchen.location || 'N/A'}
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ff6b6b;">${notStartedCount}</div>
                    <div style="font-size: 11px; color: #666;">Not Started</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffa502;">${inProgressCount}</div>
                    <div style="font-size: 11px; color: #666;">In Progress</div>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${assignments.length}</div>
                    <div style="font-size: 11px; color: #666;">Total Active</div>
                </div>
            </div>
            
            <div style="max-height: 300px; overflow-y: auto;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Current Items:</h4>
                ${assignments.length === 0 ? 
                    '<div style="text-align: center; color: #999; padding: 20px; font-size: 13px;">No items assigned</div>' :
                    assignments.map(item => {
                        const statusColors = {
                            'pending': '#ff6b6b',
                            'preparing': '#ffa502',
                            'ready': '#00ff88',
                            'completed': '#2ecc71'
                        };
                        const statusColor = statusColors[item.status] || '#999';
                        
                        // Convert to numbers for comparison
                        const started = parseInt(item.started) || 0;
                        const completed = parseInt(item.completed) || 0;
                        
                        console.log('Item:', item.food_name, 'started:', started, 'completed:', completed);
                        
                        return `
                            <div style="padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #e0e0e0; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #333; font-size: 13px;">${item.food_name}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">Order #${item.order_number} ‚Ä¢ Qty: ${item.quantity}</div>
                                    </div>
                                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; text-transform: uppercase;">
                                        ${item.status}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 5px; margin-top: 8px;">
                                    ${started === 0 ? `
                                        <button class="status-btn" data-assignment-id="${item.assignment_id}" data-new-status="preparing" style="flex: 1; padding: 5px 8px; border: none; background: #ffa502; color: white; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                            üë®‚Äçüç≥ Start
                                        </button>
                                    ` : ''}
                                    ${started === 1 && completed === 0 ? `
                                        <button class="status-btn" data-assignment-id="${item.assignment_id}" data-new-status="completed" style="flex: 1; padding: 5px 8px; border: none; background: #2ecc71; color: white; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                            ‚úÖ Complete
                                        </button>
                                    ` : ''}
                                    ${completed === 0 ? `
                                        <button class="reassign-btn" data-assignment-id="${item.assignment_id}" data-food-name="${item.food_name.replace(/"/g, '&quot;')}" data-kitchen-id="${kitchen.id}" style="flex: 1; padding: 5px 8px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                            üîÑ Move
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')
                }
            </div>
        `;
        
        container.appendChild(card);
    });
    
    // Add event listeners to all status buttons
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const newStatus = this.getAttribute('data-new-status');
            updateKitchenItemStatus(assignmentId, newStatus);
        });
    });
    
    // Add event listeners to all reassign buttons
    document.querySelectorAll('.reassign-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const foodName = this.getAttribute('data-food-name');
            const kitchenId = this.getAttribute('data-kitchen-id');
            openReassignModal(assignmentId, foodName, kitchenId);
        });
    });
}

// Refresh kitchen monitor
function refreshKitchenMonitor() {
    loadKitchenMonitor();
}

// Update item status
function updateKitchenItemStatus(assignmentId, newStatus) {
    console.log('Updating status:', assignmentId, newStatus);
    
    if (!confirm(`Mark this item as ${newStatus}?`)) return;
    
    fetch(`/api/kitchen-assignments/${assignmentId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(res => {
        console.log('Response status:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            loadKitchenMonitor(); // Refresh the view
        } else {
            alert('Error: ' + (data.error || 'Failed to update status'));
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        alert('Error updating status: ' + error.message);
    });
}

// Open reassign modal
let currentAssignmentId = null;
let currentKitchenId = null;

function openReassignModal(assignmentId, foodName, currentKitchen) {
    currentAssignmentId = assignmentId;
    currentKitchenId = currentKitchen;
    
    document.getElementById('reassignFoodName').textContent = foodName;
    
    // Load kitchens for dropdown
    fetch('/api/kitchens')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('reassignKitchenSelect');
            select.innerHTML = '<option value="">-- Select Kitchen --</option>';
            (data.kitchens || []).forEach(k => {
                if (k.id !== currentKitchen) {
                    select.innerHTML += `<option value="${k.id}">${k.icon || 'üç≥'} ${k.name}</option>`;
                }
            });
        });
    
    document.getElementById('reassignModal').style.display = 'flex';
}

function closeReassignModal() {
    document.getElementById('reassignModal').style.display = 'none';
    currentAssignmentId = null;
    currentKitchenId = null;
}

function confirmReassign() {
    const newKitchenId = document.getElementById('reassignKitchenSelect').value;
    if (!newKitchenId) {
        alert('Please select a kitchen');
        return;
    }
    
    fetch(`/api/kitchen-assignments/${currentAssignmentId}/reassign`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ kitchen_id: newKitchenId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeReassignModal();
            loadKitchenMonitor(); // Refresh the view
        } else {
            alert('Error: ' + (data.error || 'Failed to reassign'));
        }
    })
    .catch(error => {
        console.error('Error reassigning:', error);
        alert('Error reassigning: ' + error.message);
    });
}

// Auto-refresh interval variable
let kitchenMonitorInterval = null;
let countdownInterval = null;
let countdownSeconds = 5;

// Update countdown timer display
function updateCountdownTimer() {
    const countdownValue = document.getElementById('countdown-value');
    const progressBar = document.getElementById('progress-bar');
    
    if (countdownValue && progressBar) {
        countdownValue.textContent = countdownSeconds;
        const progressPercent = (countdownSeconds / 5) * 100;
        progressBar.style.width = progressPercent + '%';
    }
    
    if (countdownSeconds <= 0) {
        countdownSeconds = 5; // Reset to 5 seconds
        loadKitchenMonitor(); // Refresh data
    } else {
        countdownSeconds--;
    }
}

// Start auto-refresh when kitchen monitor is active
function startKitchenMonitorAutoRefresh() {
    // Clear any existing intervals
    if (kitchenMonitorInterval) {
        clearInterval(kitchenMonitorInterval);
    }
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Reset countdown
    countdownSeconds = 5;
    
    // Update countdown every second
    countdownInterval = setInterval(updateCountdownTimer, 1000);
}

// Stop auto-refresh when leaving kitchen monitor
function stopKitchenMonitorAutoRefresh() {
    if (kitchenMonitorInterval) {
        clearInterval(kitchenMonitorInterval);
        kitchenMonitorInterval = null;
    }
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
}
</script>
